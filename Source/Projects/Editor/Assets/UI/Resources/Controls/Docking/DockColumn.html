<link rel="import" href="../../LIB/Polymer/polymer.html">

<dom-module id="x-dock-column">
    <template>
         <content></content>
        <div id="resize-handle"></div>
    </template>
    <script>
        var DockColumnControl = Polymer({
            is: "x-dock-column",
            properties: {

            },
            listeners: {
                'resize-handle.mousedown': '_onResizeHandleMouseDown'
            },
            created: function() {
                this.parent = null;

                this._minWidth = DockNodeConfig.MinWidth;
                this._lastMouseX = 0;
            },
            attached: function() {
                this.parent = this.parentNode;

                this._lastResizeWidth = this._getWidthPixels( );

                this.$[ 'resize-handle' ].classList.add( 'active' );
            },
            detached: function() {
                this.parent = null;
            },
            get rows() {
                return this.querySelectorAll( ':scope > x-dock-container' );
            },

            /**
             * Sets the width of this column
             * @param width width in range [0, 1] representing
             *        the percentage of the parent container to contain
             */
            setWidthPercent: function(width) {
                var widthPercent = this._getWidthPercent( );

                // apply the width change to both children
                if (this.nextSibling) {
                    var nextWidthPercent = this.nextSibling._getWidthPercent( );
                    var nextMinWidth = this.nextSibling._getMinWidthPercent( );

                    var totalWidthPercent = widthPercent + nextWidthPercent;

                    var newWidthPercent = Math.min(
                        totalWidthPercent - nextMinWidth,
                        widthPercent + (width - widthPercent)
                    );

                    this.nextSibling._setWidthPercent( totalWidthPercent - newWidthPercent );

                    this._setWidthPercent( newWidthPercent );
                } else {
                    this._setWidthPercent( widthPercent + (width - widthPercent) );
                }
            },

            /**
             * Adds a row as a child to this container
             * @return {DockContainerControl}
             */
            addRow: function() {
                var row = new DockContainerControl( );

                this.appendChild( row );

                return row;
            },

            _getWidthPixels: function() {
                return this.clientWidth;
            },
            _getWidthPercent: function() {
                if (this.parent)
                    return this.clientWidth / this.parent.clientWidth;

                return 1.0;
            },
            _getMinWidthPercent: function() {
                if (this.parent)
                    return this._minWidth / this.parent.clientWidth;

                return 0.0;
            },

            _setWidthPercent: function(percent) {
                this.style.width = (Math.clamp( percent, 0.0, 1.0 ) * 100.0) + '%';
            },
            _onChildMinWidthChanged: function(width) {
                this._minWidth = Math.max( 0.0, Math.min( this._minWidth, width ) );
            },

            _onResizeHandleMouseDown: function(e) {
                this._lastMouseX = e.clientX;
                this._lastResizeWidth = this._getWidthPixels( );

                DockColumnControl.ActiveResize = this;
            },

            _handleResize: function(e) {
                var deltaX = e.clientX - this._lastMouseX;

                var newWidth = Math.max( this._minWidth, this._lastResizeWidth + deltaX );

                this.setWidthPercent( newWidth / this.parent.clientWidth );
            },
            _handleResizeEnd: function(e) {
                DockColumnControl.ActiveResize = null;
            }
        });

        DockColumnControl.ActiveResize = null;

        DockColumnControl.OnDocumentMouseMove = function(e) {
            if (DockColumnControl.ActiveResize)
                DockColumnControl.ActiveResize._handleResize( e );
        };

        DockColumnControl.OnDocumentMouseUp = function(e) {
            if (DockColumnControl.ActiveResize)
                DockColumnControl.ActiveResize._handleResizeEnd( e );
        };

        document.addEventListener( 'mousemove', DockColumnControl.OnDocumentMouseMove );
        document.addEventListener( 'mouseup', DockColumnControl.OnDocumentMouseUp );
    </script>
</dom-module>