<link rel="import" href="../LIB/Polymer/polymer.html">
<link rel="import" href="TreeView.html">
<link rel="import" href="ContextMenu.html">

<dom-module id="x-project-browser">
    <link rel="import" type="css" href="../Style/Controls/ProjectBrowser.css">
    <template>
        <div class="columns">
            <div class="left">
                <x-tree-view id="folderTree"></x-tree-view>
            </div>
            <div class="right">
                <div class="contents-toolbar">
                    <div id="breadCrumbs">
                    <template id="crumbRepeat" is="dom-repeat" items="{{crumbs}}" as="crumb">
                        <div on-click="_onCrumbSelected">{{crumb}}</div>
                    </template>
                    </div>
                </div>
                <div id="folderContent">
                <template id="folderRepeat" is="dom-repeat" items="{{directoryFolders}}" as="folder">
                    <div class="resource" on-dblclick="_onFolderDblClick" on-contextmenu="_onFolderContextMenu">
                        <div class="thumbnail folder"></div>
                        <div class="display-name">{{folder.displayName}}</div>
                    </div>
                </template>
                <template id="resourceRepeat" is="dom-repeat" items="{{directoryResources}}" as="resource">
                    <div class="resource" on-dblclick="_onResourceDblClick" on-contextmenu="_onResourceContextMenu">
                        <div class="thumbnail" ext$="{{resource.extension}}">
                            <img src="{{resource.sourceFile}}" on-error="_onResourceThumbnailError">
                        </div>
                        <div class="display-name">{{resource.displayName}}</div>
                    </div>
                </template>
                </div>
            </div>
        </div>
    </template>
    <script>
        var ProjectBrowserControl = Polymer({
            is: "x-project-browser",
            properties: {
                crumbs: {
                    type: Array,
                    value: [ ]
                },
                directoryFolders: {
                    type: Array,
                    value: [ ]
                },
                directoryResources: {
                    type: Array,
                    value: [ ]
                }
            },
            factoryImpl: function(treeRoot) {
                this._resources = treeRoot;
                this._pathToResourceEntry = { };
                this._pathToDirectoryItem = { };

                this._buildTree( treeRoot );
            },
            created: function() {
                this._lastSelectedTreeItem = null;
            },
            attached: function() {
                this.$.folderTree.setAsRoot( true );
                this.$.folderTree.enableModification = false;
            },

            browseDirectory: function(directoryPath) {
                var entry = this._pathToResourceEntry[ directoryPath ];

                if (!entry)
                    return;

                this._browseDirectory( entry );

                this._selectDirectoryItem( this._pathToDirectoryItem[ directoryPath ] );
            },

            _onTreeItemClick: function(item) {
                this._selectDirectoryItem( item );

                this._browseDirectory( item.directoryData );
            },
            _onTreeItemDblClick: function(item) {
                item.opened = !item.opened;
            },
            _onTreeItemContextMenu: function(item, e) {
                var menu = new ContextMenuControl( );

                var showInExplorer = menu.addItem( 'Show In Explorer', function() {
                    ProcessOpen( item.directoryData.path, false );
                }.bind( this ) );

                showInExplorer.icon = 'folder-closed';

                menu.open( e.clientX, e.clientY );
            },
            _onCrumbSelected: function(e) {
                var index = this.get( 'crumbs' ).length - e.model.__data__.index - 1;

                var absCrumbs = this._createDirectoryCrumbs(
                    this._lastSelectedTreeItem.directoryData.path
                );

                for (var i = 0; i < index; ++i)
                    absCrumbs.pop( );

                this.browseDirectory( absCrumbs.join( '\\' ) );
            },
            _onFolderDblClick: function(e) {
                var folder = e.model.folder;

                this._selectDirectoryItem( this._pathToDirectoryItem[ folder.path ] );
                this._browseDirectory( folder );
            },
            _onFolderContextMenu: function(e) {
                var menu = new ContextMenuControl( );

                var folder = e.model.folder;

                var showInExplorer = menu.addItem( 'Show In Explorer', function() {
                    ProcessOpen( this._getFileDirectory( folder.path ), false );
                }.bind( this ) );

                showInExplorer.icon = 'folder-closed';

                menu.open( e.clientX, e.clientY );
            },
            _onResourceDblClick: function(e) {
                this.fire( 'resource-dblclick', {
                    resource: e.model.resource
                } );
            },
            _onResourceContextMenu: function(e) {
                var menu = new ContextMenuControl( );

                var resource = e.model.resource;

                var showInExplorer = menu.addItem( 'Show In Explorer', function() {
                    ProcessOpen( this._getFileDirectory( resource.sourceFile ), false );
                }.bind( this ) );

                showInExplorer.icon = 'folder-closed';

                var open = menu.addItem( 'Open', function() {
                    ProcessOpen( resource.sourceFile, false );
                }.bind( this ) );

                open.icon = 'open-file';

                this.fire( 'resource-contextmenu', {
                    resource: e.model.resource,
                    menu: menu
                } );

                menu.open( e.clientX, e.clientY );
            },
            _onResourceThumbnailError: function(e) {
                var img = e.srcElement;
                var thumbnail = img.parentNode;

                // not sure why this happens
                if (!thumbnail)
                    return;

                thumbnail.classList.add( 'default' );
            },

            _buildTree: function(treeRoot) {
                var viewRoot = this.$.folderTree;

                for (var i = 0; i < treeRoot.subDirectories.length; ++i)
                    this._buildDirectory( treeRoot.subDirectories[ i ], viewRoot );
            },
            _buildDirectory: function(directory, parent) {
                this._pathToResourceEntry[ directory.path ] = directory;

                var item = new TreeViewItemControl( );

                item.text = directory.displayName;

                item.directoryData = directory;

                item.textElement.addEventListener( 'click', this._onTreeItemClick.bind( this, item ) );
                item.textElement.addEventListener( 'dblclick', this._onTreeItemDblClick.bind( this, item ) );
                item.textElement.addEventListener( 'contextmenu', this._onTreeItemContextMenu.bind( this, item ) );

                parent.appendChild( item );

                for (var i = 0; i < directory.subDirectories.length; ++i)
                    this._buildDirectory( directory.subDirectories[ i ], item.child );

                this._pathToDirectoryItem[ directory.path ] = item;
            },
            _browseDirectory: function(entry) {
                if (this._lastBrowsedDirectory === entry.path)
                    return;

                this._lastBrowsedDirectory = entry.path;

                var relativeDir = this._getRelativeResourceDirectory( entry.path );
                var crumbs = this._createDirectoryCrumbs( relativeDir );

                this.set( 'crumbs', crumbs );

                this.set( 'directoryFolders', entry.subDirectories );

                var defaultedThumbnails = this.querySelectorAll( '.thumbnail.default' );

                for (var i = 0; i < defaultedThumbnails.length; ++i)
                    defaultedThumbnails[ i ].classList.remove( 'default' );

                this.set( 'directoryResources', entry.resources );
            },
            _selectDirectoryItem: function(item) {
                if (this._lastSelectedTreeItem !== null)
                    this._lastSelectedTreeItem.selected = false;

                item.selected = true;

                item.scrollIntoViewIfNeeded( );

                this._lastSelectedTreeItem = item;
            },

            _createDirectoryCrumbs: function(directory) {
                return directory.split( /\/|\\/ );
            },
            _getFileDirectory: function(filename) {
                return this._createDirectoryCrumbs( filename ).slice( 0, -1 ).join( '\\' );
            },
            _getRelativeResourceDirectory: function(directory) {
                var basePathLength = this._resources.path.length;

                return directory.substr( basePathLength + 1 );
            }
        });
    </script>
</dom-module>