<link rel="import" href="../LIB/Polymer/polymer.html">
<link rel="import" href="TreeView.html">
<link rel="import" href="ContextMenu.html">

<dom-module id="x-project-browser">
    <link rel="import" type="css" href="../Style/Controls/ProjectBrowser.css">
    <template>
        <div class="columns">
            <div class="left">
                <x-tree-view id="folderTree"></x-tree-view>
            </div>
            <div class="right">
                <div class="contents-toolbar">
                    <div id="breadCrumbs">
                    <template id="crumbRepeat" is="dom-repeat" items="{{crumbs}}" as="crumb">
                        <div on-click="_onCrumbSelected">{{crumb}}</div>
                    </template>
                    </div>
                </div>
                <div id="folderContent">
                <template id="folderRepeat" is="dom-repeat" items="{{directoryFolders}}" as="folder">
                    <div class="resource" on-dblclick="_onFolderDblClick" on-contextmenu="_onFolderContextMenu">
                        <div class="thumbnail folder"></div>
                        <div class="display-name">{{folder.displayName}}</div>
                    </div>
                </template>
                <template id="resourceRepeat" is="dom-repeat" items="{{directoryResources}}" as="resource">
                    <div class="resource" on-dblclick="_onResourceDblClick" on-contextmenu="_onResourceContextMenu">
                        <div class="thumbnail" ext$="{{resource.extension}}" has-preview$="{{resource.hasPreview}}">
                        <template is="dom-if" if="{{resource.hasPreview}}">
                            <img src="{{resource.previewFile}}">
                        </template>
                        </div>
                        <div class="display-name">{{resource.displayName}}</div>
                    </div>
                </template>
                </div>
            </div>
        </div>
    </template>
    <script>
        var ProjectBrowserControl = Polymer({
            is: "x-project-browser",
            properties: {
                crumbs: {
                    type: Array,
                    value: [ ]
                },
                directoryFolders: {
                    type: Array,
                    value: [ ]
                },
                directoryResources: {
                    type: Array,
                    value: [ ]
                }
            },
            factoryImpl: function(treeRoot) {
                this._resources = treeRoot;
                this._pathToResourceEntry = { };
                this._pathToDirectoryItem = { };

                this._projectDirectory =
                    this._createDirectoryCrumbs( this._resources.path )
                        .slice( 0, -1 )
                        .join( '\\' );

                this._buildTree( treeRoot );
            },
            created: function() {
                this._lastSelectedTreeItem = null;
            },
            attached: function() {
                this.$.folderTree.setAsRoot( true );
                this.$.folderTree.enableModification = false;
            },

            browseDirectory: function(directoryPath) {
                var entry = this._pathToResourceEntry[ directoryPath ];

                if (!entry)
                    return;

                this._browseDirectory( entry );

                this._selectDirectoryItem( this._pathToDirectoryItem[ directoryPath ] );
            },
            addResource: function(resourceData) {
                var currentNode = this._resources;

                var directories = this._createDirectoryCrumbs( resourceData.relativePathDisplayName );

                // remove the file name
                directories.pop( );

                var currentPath = this._projectDirectory;

                for (var i = 0; i < directories.length; ++i) {
                    var directory = directories[ i ];

                    currentPath += '\\'+ directory;

                    var subDir = currentNode.subDirectories.find( function(inputDir, dir) {
                        return this._createDirectoryCrumbs( dir.path ).pop( ) == inputDir;
                    }.bind( this, directory ) );

                    // exists, advance the node
                    if (subDir) {
                        currentNode = subDir;
                    } else {
                        var newNode = this._createDirectoryNode( currentPath );

                        currentNode.subDirectories.push( newNode );

                        var currentItem = this._pathToDirectoryItem[ currentNode.path ];

                        currentItem.child.appendChild(
                            this._createDirectoryTreeItem( newNode )
                        );

                        currentNode = newNode;
                    }
                }

                currentNode.resources.push( resourceData );

                // if this directory is open, refresh the contents
                if (this._lastSelectedTreeItem && this._lastSelectedTreeItem.directoryData.path == currentNode.path) {
                    this.set( 'directoryFolders', currentNode.subDirectories.slice( 0 ) );
                    this.set( 'directoryResources', currentNode.resources.slice( 0 ) );
                }
            },

            _onTreeItemClick: function(item) {
                this._selectDirectoryItem( item );

                this._browseDirectory( item.directoryData );
            },
            _onTreeItemDblClick: function(item) {
                item.opened = !item.opened;
            },
            _onTreeItemContextMenu: function(item, e) {
                var menu = new ContextMenuControl( );

                var showInExplorer = menu.addItem( 'Show In Explorer', function() {
                    ProcessOpen( item.directoryData.path, false );
                }.bind( this ) );

                showInExplorer.icon = 'folder-closed';

                menu.open( e.clientX, e.clientY );
            },
            _onCrumbSelected: function(e) {
                var index = this.get( 'crumbs' ).length - e.model.__data__.index - 1;

                var absCrumbs = this._createDirectoryCrumbs(
                    this._lastSelectedTreeItem.directoryData.path
                );

                for (var i = 0; i < index; ++i)
                    absCrumbs.pop( );

                this.browseDirectory( absCrumbs.join( '\\' ) );
            },
            _onFolderDblClick: function(e) {
                var folder = e.model.folder;

                this._selectDirectoryItem( this._pathToDirectoryItem[ folder.path ] );
                this._browseDirectory( folder );
            },
            _onFolderContextMenu: function(e) {
                var menu = new ContextMenuControl( );

                var folder = e.model.folder;

                var showInExplorer = menu.addItem( 'Show In Explorer', function() {
                    ProcessOpen( this._getFileDirectory( folder.path ), false );
                }.bind( this ) );

                showInExplorer.icon = 'folder-closed';

                menu.open( e.clientX, e.clientY );
            },
            _onResourceDblClick: function(e) {
                this.fire( 'resource-dblclick', {
                    resource: e.model.resource
                } );
            },
            _onResourceContextMenu: function(e) {
                var menu = new ContextMenuControl( );

                var resource = e.model.resource;

                var showInExplorer = menu.addItem( 'Show In Explorer', function() {
                    ProcessOpen( this._getFileDirectory( resource.sourceFile ), false );
                }.bind( this ) );

                showInExplorer.icon = 'folder-closed';

                var open = menu.addItem( 'Open', function() {
                    ProcessOpen( resource.sourceFile, false );
                }.bind( this ) );

                open.icon = 'open-file';

                if (e.ctrlKey) {
                    menu.addSeparator( );

                    var makeEditorResource = menu.addItem( 'Make Editor Resource', function() {
                        ProjectMakeEditorResource( resource.guid );
                    }.bind( this ) );
                }

                this.fire( 'resource-contextmenu', {
                    resource: e.model.resource,
                    menu: menu
                } );

                menu.open( e.clientX, e.clientY );
            },

            _buildTree: function(treeRoot) {
                this._buildDirectory( treeRoot, this.$.folderTree );
            },
            _buildDirectory: function(directory, parent) {
                var item = this._createDirectoryTreeItem( directory );

                parent.appendChild( item );

                for (var i = 0; i < directory.subDirectories.length; ++i)
                    this._buildDirectory( directory.subDirectories[ i ], item.child );
            },
            _browseDirectory: function(entry) {
                if (this._lastBrowsedDirectory === entry.path)
                    return;

                this._lastBrowsedDirectory = entry.path;

                var relativeDir = this._getRelativeResourceDirectory( entry.path );
                var crumbs = this._createDirectoryCrumbs( relativeDir );

                this.set( 'crumbs', crumbs );

                this.set( 'directoryFolders', entry.subDirectories.slice( 0 ) );

                this.set( 'directoryResources', entry.resources.slice( 0 ) );
            },
            _selectDirectoryItem: function(item) {
                if (this._lastSelectedTreeItem !== null)
                    this._lastSelectedTreeItem.selected = false;

                item.selected = true;

                item.scrollIntoViewIfNeeded( );

                this._lastSelectedTreeItem = item;
            },

            _createDirectoryTreeItem: function(directoryNode) {
                var item = new TreeViewItemControl( );

                item.text = directoryNode.displayName;

                item.directoryData = directoryNode;

                item.textElement.addEventListener( 'click', this._onTreeItemClick.bind( this, item ) );
                item.textElement.addEventListener( 'dblclick', this._onTreeItemDblClick.bind( this, item ) );
                item.textElement.addEventListener( 'contextmenu', this._onTreeItemContextMenu.bind( this, item ) );

                this._pathToResourceEntry[ directoryNode.path ] = directoryNode;
                this._pathToDirectoryItem[ directoryNode.path ] = item;

                return item;
            },
            _createDirectoryNode: function(path) {
                return {
                    path: path,
                    displayName: this._createDirectoryCrumbs( path ).pop( ),
                    subDirectories: [ ],
                    resources: [ ]
                };
            },
            _createDirectoryCrumbs: function(directory) {
                return directory.split( /\/|\\/ );
            },
            _getFileDirectory: function(filename) {
                return this._createDirectoryCrumbs( filename ).slice( 0, -1 ).join( '\\' );
            },
            _getRelativeResourceDirectory: function(directory) {
                var basePathLength = this._projectDirectory.length;

                return directory.substr( basePathLength + 1 );
            }
        });
    </script>
</dom-module>