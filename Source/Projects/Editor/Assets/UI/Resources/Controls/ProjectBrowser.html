<link rel="import" href="../LIB/Polymer/polymer.html">
<link rel="import" href="TreeView.html">

<dom-module id="x-project-browser">
    <link rel="import" type="css" href="../Style/Controls/ProjectBrowser.css">
    <template>
        <div class="columns">
            <div class="left">
                <x-tree-view id="folderTree"></x-tree-view>
            </div>
            <div class="right">
                <div id="breadCrumbs">
                <template id="crumbRepeat" is="dom-repeat" items="{{crumbs}}" as="crumb">
                    <div on-click="_onCrumbSelected">{{crumb}}</div>
                </template>
                </div>
                <div id="folderContent">
                <template id="resourceRepeat" is="dom-repeat" items="{{directoryResources}}" as="resource">
                    <div class="resource" ext$="{{resource.extension}}">
                        <img class="thumbnail" src="{{resource.sourceFile}}" on-error="_onResourceThumbnailError">
                        <div class="display-name">{{resource.displayName}}</div>
                    </div>
                </template>
                </div>
            </div>
        </div>
    </template>
    <script>
        var ProjectBrowserControl = Polymer({
            is: "x-project-browser",
            properties: {
                crumbs: {
                    type: Array,
                    value: [ ]
                },
                directoryResources: {
                    type: Array,
                    value: [ ]
                }
            },
            factoryImpl: function(treeRoot) {
                this._resources = treeRoot;
                this._pathToResourceEntry = { };
                this._pathToDirectoryItem = { };

                this._buildTree( treeRoot );
            },
            created: function() {
                this._lastSelectedTreeItem = null;
            },
            attached: function() {
                this.$.folderTree.setAsRoot( true );
                this.$.folderTree.enableModification = false;
            },

            browseDirectory: function(directoryPath) {
                var entry = this._pathToResourceEntry[ directoryPath ];

                if (!entry)
                    return;

                this._browseDirectory( entry );

                this._selectDirectoryItem( this._pathToDirectoryItem[ directoryPath ] );
            },

            _onTreeItemClick: function(item) {
                this._selectDirectoryItem( item );

                this._browseDirectory( item.directoryData );
            },
            _onTreeItemDblClick: function(item) {
                item.opened = !item.opened;
            },
            _onCrumbSelected: function(e) {
                var index = this.get( 'crumbs' ).length - e.model.__data__.index - 1;

                var absCrumbs = this._createDirectoryCrumbs(
                    this._lastSelectedTreeItem.directoryData.path
                );

                for (var i = 0; i < index; ++i)
                    absCrumbs.pop( );

                this.browseDirectory( absCrumbs.join( '\\' ) );
            },
            _onResourceThumbnailError: function(e) {
                console.log( e.model );
            },

            _buildTree: function(treeRoot) {
                var viewRoot = this.$.folderTree;

                for (var i = 0; i < treeRoot.subDirectories.length; ++i)
                    this._buildDirectory( treeRoot.subDirectories[ i ], viewRoot );
            },
            _buildDirectory: function(directory, parent) {
                this._pathToResourceEntry[ directory.path ] = directory;

                var item = new TreeViewItemControl( );

                item.text = directory.displayName;

                item.directoryData = directory;

                item.textElement.addEventListener( 'click', this._onTreeItemClick.bind( this, item ) );
                item.textElement.addEventListener( 'dblclick', this._onTreeItemDblClick.bind( this, item ) );

                parent.appendChild( item );

                for (var i = 0; i < directory.subDirectories.length; ++i)
                    this._buildDirectory( directory.subDirectories[ i ], item.child );

                this._pathToDirectoryItem[ directory.path ] = item;
            },
            _browseDirectory: function(entry) {
                var relativeDir = this._getRelativeResourceDirectory( entry.path );
                var crumbs = this._createDirectoryCrumbs( relativeDir );

                this.set( 'crumbs', crumbs );

                this.set( 'directoryResources', entry.resources );
            },
            _selectDirectoryItem: function(item) {
                if (this._lastSelectedTreeItem !== null)
                    this._lastSelectedTreeItem.selected = false;

                item.selected = true;

                this._lastSelectedTreeItem = item;
            },

            _createDirectoryCrumbs: function(directory) {
                return directory.split( /\/|\\/ );
            },
            _getRelativeResourceDirectory: function(directory) {
                var basePathLength = this._resources.path.length;

                return directory.substr( basePathLength + 1 );
            }
        });
    </script>
</dom-module>